name: Daily Policy Drift Detection

on:
  schedule:
    # Run daily at 2:00 AM UTC (12:00 PM AEST)
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual triggering

permissions:
  id-token: write # Required for OIDC authentication with AWS
  contents: read

jobs:
  # Heartbeat Publisher - Dev
  heartbeat-dev:
    name: Heartbeat (dev)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN__MONOREPO_FEM__HEARTBEAT_PUBLISHER__DEV }}
          aws-region: ap-southeast-2

      - name: Check policy drift
        continue-on-error: true
        run: |
          set +e

          ENV="dev"
          POLICY_FILE=".github/policies/heartbeat-publisher-deploy-policy.json"
          APP_NAME="heartbeat-publisher"
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          AWS_REGION="ap-southeast-2"

          echo "=== Policy Drift Check ==="
          echo "App: $APP_NAME"
          echo "Environment: $ENV"
          echo "Policy file: $POLICY_FILE"
          echo ""

          # Check if policy file exists
          if [ ! -f "$POLICY_FILE" ]; then
            echo "❌ ERROR: Policy file not found: $POLICY_FILE"
            exit 1
          fi

          # Get deployment role name from secret
          DEPLOY_ROLE_ARN="${{ secrets.AWS_OIDC_ROLE_ARN__MONOREPO_FEM__HEARTBEAT_PUBLISHER__DEV }}"
          DEPLOY_ROLE_NAME=$(echo "$DEPLOY_ROLE_ARN" | sed 's|.*/||')

          echo "Deployment role: $DEPLOY_ROLE_NAME"
          echo ""

          # Get inline policy from deployment role
          echo "Retrieving deployed policy for role: $DEPLOY_ROLE_NAME"
          POLICY_NAMES=$(aws iam list-role-policies \
            --role-name "$DEPLOY_ROLE_NAME" \
            --query 'PolicyNames[0]' \
            --output text)

          if [ -z "$POLICY_NAMES" ] || [ "$POLICY_NAMES" == "None" ]; then
            echo "⚠️  WARNING: No inline policies found on deployment role"
            exit 0
          fi

          # Get the policy document
          aws iam get-role-policy \
            --role-name "$DEPLOY_ROLE_NAME" \
            --policy-name "$POLICY_NAMES" \
            --query 'PolicyDocument' \
            --output json > /tmp/deployed-policy-raw.json

          if [ $? -ne 0 ]; then
            echo "⚠️  WARNING: Failed to retrieve deployed policy"
            exit 0
          fi

          echo "✓ Retrieved deployed policy"
          echo ""

          # Normalise both policies
          echo "Normalising policies for comparison..."

          .github/scripts/normalise-policy.sh \
            "$POLICY_FILE" \
            "$AWS_ACCOUNT_ID" \
            "$AWS_REGION" \
            "$ENV" \
            > /tmp/repository-policy-normalised.json

          cat /tmp/deployed-policy-raw.json | jq --sort-keys '.' > /tmp/deployed-policy-normalised.json

          echo "✓ Policies normalised"
          echo ""

          # Compare policies
          echo "Comparing deployed policy with repository policy..."
          .github/scripts/compare-policies.sh \
            /tmp/deployed-policy-normalised.json \
            /tmp/repository-policy-normalised.json

          # Check if there were differences
          if grep -q "Policy differences detected" /tmp/comparison-output.txt 2>/dev/null; then
            echo "::warning::Policy drift detected for $APP_NAME in $ENV environment"
          else
            echo "✓ No policy drift detected"
          fi

          exit 0

  # Heartbeat Publisher - Exp
  heartbeat-exp:
    name: Heartbeat (exp)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN__MONOREPO_FEM__HEARTBEAT_PUBLISHER__EXP }}
          aws-region: ap-southeast-2

      - name: Check policy drift
        continue-on-error: true
        run: |
          set +e

          ENV="exp"
          POLICY_FILE=".github/policies/heartbeat-publisher-deploy-policy.json"
          APP_NAME="heartbeat-publisher"
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          AWS_REGION="ap-southeast-2"

          echo "=== Policy Drift Check ==="
          echo "App: $APP_NAME"
          echo "Environment: $ENV"
          echo "Policy file: $POLICY_FILE"
          echo ""

          if [ ! -f "$POLICY_FILE" ]; then
            echo "❌ ERROR: Policy file not found: $POLICY_FILE"
            exit 1
          fi

          DEPLOY_ROLE_ARN="${{ secrets.AWS_OIDC_ROLE_ARN__MONOREPO_FEM__HEARTBEAT_PUBLISHER__EXP }}"
          DEPLOY_ROLE_NAME=$(echo "$DEPLOY_ROLE_ARN" | sed 's|.*/||')

          echo "Deployment role: $DEPLOY_ROLE_NAME"
          echo ""

          echo "Retrieving deployed policy for role: $DEPLOY_ROLE_NAME"
          POLICY_NAMES=$(aws iam list-role-policies \
            --role-name "$DEPLOY_ROLE_NAME" \
            --query 'PolicyNames[0]' \
            --output text)

          if [ -z "$POLICY_NAMES" ] || [ "$POLICY_NAMES" == "None" ]; then
            echo "⚠️  WARNING: No inline policies found on deployment role"
            exit 0
          fi

          aws iam get-role-policy \
            --role-name "$DEPLOY_ROLE_NAME" \
            --policy-name "$POLICY_NAMES" \
            --query 'PolicyDocument' \
            --output json > /tmp/deployed-policy-raw.json

          if [ $? -ne 0 ]; then
            echo "⚠️  WARNING: Failed to retrieve deployed policy"
            exit 0
          fi

          echo "✓ Retrieved deployed policy"
          echo ""

          echo "Normalising policies for comparison..."

          .github/scripts/normalise-policy.sh \
            "$POLICY_FILE" \
            "$AWS_ACCOUNT_ID" \
            "$AWS_REGION" \
            "$ENV" \
            > /tmp/repository-policy-normalised.json

          cat /tmp/deployed-policy-raw.json | jq --sort-keys '.' > /tmp/deployed-policy-normalised.json

          echo "✓ Policies normalised"
          echo ""

          echo "Comparing deployed policy with repository policy..."
          .github/scripts/compare-policies.sh \
            /tmp/deployed-policy-normalised.json \
            /tmp/repository-policy-normalised.json

          if grep -q "Policy differences detected" /tmp/comparison-output.txt 2>/dev/null; then
            echo "::warning::Policy drift detected for $APP_NAME in $ENV environment"
          else
            echo "✓ No policy drift detected"
          fi

          exit 0

  # Heartbeat Publisher - Prod
  heartbeat-prod:
    name: Heartbeat (prod)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN__MONOREPO_FEM__HEARTBEAT_PUBLISHER__PROD }}
          aws-region: ap-southeast-2

      - name: Check policy drift
        continue-on-error: true
        run: |
          set +e

          ENV="prod"
          POLICY_FILE=".github/policies/heartbeat-publisher-deploy-policy.json"
          APP_NAME="heartbeat-publisher"
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          AWS_REGION="ap-southeast-2"

          echo "=== Policy Drift Check ==="
          echo "App: $APP_NAME"
          echo "Environment: $ENV"
          echo "Policy file: $POLICY_FILE"
          echo ""

          if [ ! -f "$POLICY_FILE" ]; then
            echo "❌ ERROR: Policy file not found: $POLICY_FILE"
            exit 1
          fi

          DEPLOY_ROLE_ARN="${{ secrets.AWS_OIDC_ROLE_ARN__MONOREPO_FEM__HEARTBEAT_PUBLISHER__PROD }}"
          DEPLOY_ROLE_NAME=$(echo "$DEPLOY_ROLE_ARN" | sed 's|.*/||')

          echo "Deployment role: $DEPLOY_ROLE_NAME"
          echo ""

          echo "Retrieving deployed policy for role: $DEPLOY_ROLE_NAME"
          POLICY_NAMES=$(aws iam list-role-policies \
            --role-name "$DEPLOY_ROLE_NAME" \
            --query 'PolicyNames[0]' \
            --output text)

          if [ -z "$POLICY_NAMES" ] || [ "$POLICY_NAMES" == "None" ]; then
            echo "⚠️  WARNING: No inline policies found on deployment role"
            exit 0
          fi

          aws iam get-role-policy \
            --role-name "$DEPLOY_ROLE_NAME" \
            --policy-name "$POLICY_NAMES" \
            --query 'PolicyDocument' \
            --output json > /tmp/deployed-policy-raw.json

          if [ $? -ne 0 ]; then
            echo "⚠️  WARNING: Failed to retrieve deployed policy"
            exit 0
          fi

          echo "✓ Retrieved deployed policy"
          echo ""

          echo "Normalising policies for comparison..."

          .github/scripts/normalise-policy.sh \
            "$POLICY_FILE" \
            "$AWS_ACCOUNT_ID" \
            "$AWS_REGION" \
            "$ENV" \
            > /tmp/repository-policy-normalised.json

          cat /tmp/deployed-policy-raw.json | jq --sort-keys '.' > /tmp/deployed-policy-normalised.json

          echo "✓ Policies normalised"
          echo ""

          echo "Comparing deployed policy with repository policy..."
          .github/scripts/compare-policies.sh \
            /tmp/deployed-policy-normalised.json \
            /tmp/repository-policy-normalised.json

          if grep -q "Policy differences detected" /tmp/comparison-output.txt 2>/dev/null; then
            echo "::error::Policy drift detected for $APP_NAME in $ENV environment"
            exit 1
          else
            echo "✓ No policy drift detected"
          fi

          exit 0

  # Pulse Publisher - Dev
  pulse-dev:
    name: Pulse (dev)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN__MONOREPO_FEM__PULSE_PUBLISHER__DEV }}
          aws-region: ap-southeast-2

      - name: Check policy drift
        continue-on-error: true
        run: |
          set +e

          ENV="dev"
          POLICY_FILE=".github/policies/pulse-publisher-deploy-policy.json"
          APP_NAME="pulse-publisher"
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          AWS_REGION="ap-southeast-2"

          echo "=== Policy Drift Check ==="
          echo "App: $APP_NAME"
          echo "Environment: $ENV"
          echo "Policy file: $POLICY_FILE"
          echo ""

          if [ ! -f "$POLICY_FILE" ]; then
            echo "❌ ERROR: Policy file not found: $POLICY_FILE"
            exit 1
          fi

          DEPLOY_ROLE_ARN="${{ secrets.AWS_OIDC_ROLE_ARN__MONOREPO_FEM__PULSE_PUBLISHER__DEV }}"
          DEPLOY_ROLE_NAME=$(echo "$DEPLOY_ROLE_ARN" | sed 's|.*/||')

          echo "Deployment role: $DEPLOY_ROLE_NAME"
          echo ""

          echo "Retrieving deployed policy for role: $DEPLOY_ROLE_NAME"
          POLICY_NAMES=$(aws iam list-role-policies \
            --role-name "$DEPLOY_ROLE_NAME" \
            --query 'PolicyNames[0]' \
            --output text)

          if [ -z "$POLICY_NAMES" ] || [ "$POLICY_NAMES" == "None" ]; then
            echo "⚠️  WARNING: No inline policies found on deployment role"
            exit 0
          fi

          aws iam get-role-policy \
            --role-name "$DEPLOY_ROLE_NAME" \
            --policy-name "$POLICY_NAMES" \
            --query 'PolicyDocument' \
            --output json > /tmp/deployed-policy-raw.json

          if [ $? -ne 0 ]; then
            echo "⚠️  WARNING: Failed to retrieve deployed policy"
            exit 0
          fi

          echo "✓ Retrieved deployed policy"
          echo ""

          echo "Normalising policies for comparison..."

          .github/scripts/normalise-policy.sh \
            "$POLICY_FILE" \
            "$AWS_ACCOUNT_ID" \
            "$AWS_REGION" \
            "$ENV" \
            > /tmp/repository-policy-normalised.json

          cat /tmp/deployed-policy-raw.json | jq --sort-keys '.' > /tmp/deployed-policy-normalised.json

          echo "✓ Policies normalised"
          echo ""

          echo "Comparing deployed policy with repository policy..."
          .github/scripts/compare-policies.sh \
            /tmp/deployed-policy-normalised.json \
            /tmp/repository-policy-normalised.json

          if grep -q "Policy differences detected" /tmp/comparison-output.txt 2>/dev/null; then
            echo "::warning::Policy drift detected for $APP_NAME in $ENV environment"
          else
            echo "✓ No policy drift detected"
          fi

          exit 0

  # Pulse Publisher - Exp
  pulse-exp:
    name: Pulse (exp)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN__MONOREPO_FEM__PULSE_PUBLISHER__EXP }}
          aws-region: ap-southeast-2

      - name: Check policy drift
        continue-on-error: true
        run: |
          set +e

          ENV="exp"
          POLICY_FILE=".github/policies/pulse-publisher-deploy-policy.json"
          APP_NAME="pulse-publisher"
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          AWS_REGION="ap-southeast-2"

          echo "=== Policy Drift Check ==="
          echo "App: $APP_NAME"
          echo "Environment: $ENV"
          echo "Policy file: $POLICY_FILE"
          echo ""

          if [ ! -f "$POLICY_FILE" ]; then
            echo "❌ ERROR: Policy file not found: $POLICY_FILE"
            exit 1
          fi

          DEPLOY_ROLE_ARN="${{ secrets.AWS_OIDC_ROLE_ARN__MONOREPO_FEM__PULSE_PUBLISHER__EXP }}"
          DEPLOY_ROLE_NAME=$(echo "$DEPLOY_ROLE_ARN" | sed 's|.*/||')

          echo "Deployment role: $DEPLOY_ROLE_NAME"
          echo ""

          echo "Retrieving deployed policy for role: $DEPLOY_ROLE_NAME"
          POLICY_NAMES=$(aws iam list-role-policies \
            --role-name "$DEPLOY_ROLE_NAME" \
            --query 'PolicyNames[0]' \
            --output text)

          if [ -z "$POLICY_NAMES" ] || [ "$POLICY_NAMES" == "None" ]; then
            echo "⚠️  WARNING: No inline policies found on deployment role"
            exit 0
          fi

          aws iam get-role-policy \
            --role-name "$DEPLOY_ROLE_NAME" \
            --policy-name "$POLICY_NAMES" \
            --query 'PolicyDocument' \
            --output json > /tmp/deployed-policy-raw.json

          if [ $? -ne 0 ]; then
            echo "⚠️  WARNING: Failed to retrieve deployed policy"
            exit 0
          fi

          echo "✓ Retrieved deployed policy"
          echo ""

          echo "Normalising policies for comparison..."

          .github/scripts/normalise-policy.sh \
            "$POLICY_FILE" \
            "$AWS_ACCOUNT_ID" \
            "$AWS_REGION" \
            "$ENV" \
            > /tmp/repository-policy-normalised.json

          cat /tmp/deployed-policy-raw.json | jq --sort-keys '.' > /tmp/deployed-policy-normalised.json

          echo "✓ Policies normalised"
          echo ""

          echo "Comparing deployed policy with repository policy..."
          .github/scripts/compare-policies.sh \
            /tmp/deployed-policy-normalised.json \
            /tmp/repository-policy-normalised.json

          if grep -q "Policy differences detected" /tmp/comparison-output.txt 2>/dev/null; then
            echo "::warning::Policy drift detected for $APP_NAME in $ENV environment"
          else
            echo "✓ No policy drift detected"
          fi

          exit 0

  # Pulse Publisher - Prod
  pulse-prod:
    name: Pulse (prod)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN__MONOREPO_FEM__PULSE_PUBLISHER__PROD }}
          aws-region: ap-southeast-2

      - name: Check policy drift
        continue-on-error: true
        run: |
          set +e

          ENV="prod"
          POLICY_FILE=".github/policies/pulse-publisher-deploy-policy.json"
          APP_NAME="pulse-publisher"
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          AWS_REGION="ap-southeast-2"

          echo "=== Policy Drift Check ==="
          echo "App: $APP_NAME"
          echo "Environment: $ENV"
          echo "Policy file: $POLICY_FILE"
          echo ""

          if [ ! -f "$POLICY_FILE" ]; then
            echo "❌ ERROR: Policy file not found: $POLICY_FILE"
            exit 1
          fi

          DEPLOY_ROLE_ARN="${{ secrets.AWS_OIDC_ROLE_ARN__MONOREPO_FEM__PULSE_PUBLISHER__PROD }}"
          DEPLOY_ROLE_NAME=$(echo "$DEPLOY_ROLE_ARN" | sed 's|.*/||')

          echo "Deployment role: $DEPLOY_ROLE_NAME"
          echo ""

          echo "Retrieving deployed policy for role: $DEPLOY_ROLE_NAME"
          POLICY_NAMES=$(aws iam list-role-policies \
            --role-name "$DEPLOY_ROLE_NAME" \
            --query 'PolicyNames[0]' \
            --output text)

          if [ -z "$POLICY_NAMES" ] || [ "$POLICY_NAMES" == "None" ]; then
            echo "⚠️  WARNING: No inline policies found on deployment role"
            exit 0
          fi

          aws iam get-role-policy \
            --role-name "$DEPLOY_ROLE_NAME" \
            --policy-name "$POLICY_NAMES" \
            --query 'PolicyDocument' \
            --output json > /tmp/deployed-policy-raw.json

          if [ $? -ne 0 ]; then
            echo "⚠️  WARNING: Failed to retrieve deployed policy"
            exit 0
          fi

          echo "✓ Retrieved deployed policy"
          echo ""

          echo "Normalising policies for comparison..."

          .github/scripts/normalise-policy.sh \
            "$POLICY_FILE" \
            "$AWS_ACCOUNT_ID" \
            "$AWS_REGION" \
            "$ENV" \
            > /tmp/repository-policy-normalised.json

          cat /tmp/deployed-policy-raw.json | jq --sort-keys '.' > /tmp/deployed-policy-normalised.json

          echo "✓ Policies normalised"
          echo ""

          echo "Comparing deployed policy with repository policy..."
          .github/scripts/compare-policies.sh \
            /tmp/deployed-policy-normalised.json \
            /tmp/repository-policy-normalised.json

          if grep -q "Policy differences detected" /tmp/comparison-output.txt 2>/dev/null; then
            echo "::error::Policy drift detected for $APP_NAME in $ENV environment"
            exit 1
          else
            echo "✓ No policy drift detected"
          fi

          exit 0

  # Scryscraper - Dev
  scryscraper-dev:
    name: Scryscraper (dev)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN__MONOREPO_FEM__SCRYSCRAPER__DEV }}
          aws-region: ap-southeast-2

      - name: Check policy drift
        continue-on-error: true
        run: |
          set +e

          ENV="dev"
          POLICY_FILE=".github/policies/scryscraper-deploy-policy.json"
          APP_NAME="scryscraper"
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          AWS_REGION="ap-southeast-2"

          echo "=== Policy Drift Check ==="
          echo "App: $APP_NAME"
          echo "Environment: $ENV"
          echo "Policy file: $POLICY_FILE"
          echo ""

          if [ ! -f "$POLICY_FILE" ]; then
            echo "❌ ERROR: Policy file not found: $POLICY_FILE"
            exit 1
          fi

          DEPLOY_ROLE_ARN="${{ secrets.AWS_OIDC_ROLE_ARN__MONOREPO_FEM__SCRYSCRAPER__DEV }}"
          DEPLOY_ROLE_NAME=$(echo "$DEPLOY_ROLE_ARN" | sed 's|.*/||')

          echo "Deployment role: $DEPLOY_ROLE_NAME"
          echo ""

          echo "Retrieving deployed policy for role: $DEPLOY_ROLE_NAME"
          POLICY_NAMES=$(aws iam list-role-policies \
            --role-name "$DEPLOY_ROLE_NAME" \
            --query 'PolicyNames[0]' \
            --output text)

          if [ -z "$POLICY_NAMES" ] || [ "$POLICY_NAMES" == "None" ]; then
            echo "⚠️  WARNING: No inline policies found on deployment role"
            exit 0
          fi

          aws iam get-role-policy \
            --role-name "$DEPLOY_ROLE_NAME" \
            --policy-name "$POLICY_NAMES" \
            --query 'PolicyDocument' \
            --output json > /tmp/deployed-policy-raw.json

          if [ $? -ne 0 ]; then
            echo "⚠️  WARNING: Failed to retrieve deployed policy"
            exit 0
          fi

          echo "✓ Retrieved deployed policy"
          echo ""

          echo "Normalising policies for comparison..."

          .github/scripts/normalise-policy.sh \
            "$POLICY_FILE" \
            "$AWS_ACCOUNT_ID" \
            "$AWS_REGION" \
            "$ENV" \
            > /tmp/repository-policy-normalised.json

          cat /tmp/deployed-policy-raw.json | jq --sort-keys '.' > /tmp/deployed-policy-normalised.json

          echo "✓ Policies normalised"
          echo ""

          echo "Comparing deployed policy with repository policy..."
          .github/scripts/compare-policies.sh \
            /tmp/deployed-policy-normalised.json \
            /tmp/repository-policy-normalised.json

          if grep -q "Policy differences detected" /tmp/comparison-output.txt 2>/dev/null; then
            echo "::warning::Policy drift detected for $APP_NAME in $ENV environment"
          else
            echo "✓ No policy drift detected"
          fi

          exit 0

  # Scryscraper - Exp
  scryscraper-exp:
    name: Scryscraper (exp)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN__MONOREPO_FEM__SCRYSCRAPER__EXP }}
          aws-region: ap-southeast-2

      - name: Check policy drift
        continue-on-error: true
        run: |
          set +e

          ENV="exp"
          POLICY_FILE=".github/policies/scryscraper-deploy-policy.json"
          APP_NAME="scryscraper"
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          AWS_REGION="ap-southeast-2"

          echo "=== Policy Drift Check ==="
          echo "App: $APP_NAME"
          echo "Environment: $ENV"
          echo "Policy file: $POLICY_FILE"
          echo ""

          if [ ! -f "$POLICY_FILE" ]; then
            echo "❌ ERROR: Policy file not found: $POLICY_FILE"
            exit 1
          fi

          DEPLOY_ROLE_ARN="${{ secrets.AWS_OIDC_ROLE_ARN__MONOREPO_FEM__SCRYSCRAPER__EXP }}"
          DEPLOY_ROLE_NAME=$(echo "$DEPLOY_ROLE_ARN" | sed 's|.*/||')

          echo "Deployment role: $DEPLOY_ROLE_NAME"
          echo ""

          echo "Retrieving deployed policy for role: $DEPLOY_ROLE_NAME"
          POLICY_NAMES=$(aws iam list-role-policies \
            --role-name "$DEPLOY_ROLE_NAME" \
            --query 'PolicyNames[0]' \
            --output text)

          if [ -z "$POLICY_NAMES" ] || [ "$POLICY_NAMES" == "None" ]; then
            echo "⚠️  WARNING: No inline policies found on deployment role"
            exit 0
          fi

          aws iam get-role-policy \
            --role-name "$DEPLOY_ROLE_NAME" \
            --policy-name "$POLICY_NAMES" \
            --query 'PolicyDocument' \
            --output json > /tmp/deployed-policy-raw.json

          if [ $? -ne 0 ]; then
            echo "⚠️  WARNING: Failed to retrieve deployed policy"
            exit 0
          fi

          echo "✓ Retrieved deployed policy"
          echo ""

          echo "Normalising policies for comparison..."

          .github/scripts/normalise-policy.sh \
            "$POLICY_FILE" \
            "$AWS_ACCOUNT_ID" \
            "$AWS_REGION" \
            "$ENV" \
            > /tmp/repository-policy-normalised.json

          cat /tmp/deployed-policy-raw.json | jq --sort-keys '.' > /tmp/deployed-policy-normalised.json

          echo "✓ Policies normalised"
          echo ""

          echo "Comparing deployed policy with repository policy..."
          .github/scripts/compare-policies.sh \
            /tmp/deployed-policy-normalised.json \
            /tmp/repository-policy-normalised.json

          if grep -q "Policy differences detected" /tmp/comparison-output.txt 2>/dev/null; then
            echo "::warning::Policy drift detected for $APP_NAME in $ENV environment"
          else
            echo "✓ No policy drift detected"
          fi

          exit 0

  # Scryscraper - Prod
  scryscraper-prod:
    name: Scryscraper (prod)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN__MONOREPO_FEM__SCRYSCRAPER__PROD }}
          aws-region: ap-southeast-2

      - name: Check policy drift
        continue-on-error: true
        run: |
          set +e

          ENV="prod"
          POLICY_FILE=".github/policies/scryscraper-deploy-policy.json"
          APP_NAME="scryscraper"
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          AWS_REGION="ap-southeast-2"

          echo "=== Policy Drift Check ==="
          echo "App: $APP_NAME"
          echo "Environment: $ENV"
          echo "Policy file: $POLICY_FILE"
          echo ""

          if [ ! -f "$POLICY_FILE" ]; then
            echo "❌ ERROR: Policy file not found: $POLICY_FILE"
            exit 1
          fi

          DEPLOY_ROLE_ARN="${{ secrets.AWS_OIDC_ROLE_ARN__MONOREPO_FEM__SCRYSCRAPER__PROD }}"
          DEPLOY_ROLE_NAME=$(echo "$DEPLOY_ROLE_ARN" | sed 's|.*/||')

          echo "Deployment role: $DEPLOY_ROLE_NAME"
          echo ""

          echo "Retrieving deployed policy for role: $DEPLOY_ROLE_NAME"
          POLICY_NAMES=$(aws iam list-role-policies \
            --role-name "$DEPLOY_ROLE_NAME" \
            --query 'PolicyNames[0]' \
            --output text)

          if [ -z "$POLICY_NAMES" ] || [ "$POLICY_NAMES" == "None" ]; then
            echo "⚠️  WARNING: No inline policies found on deployment role"
            exit 0
          fi

          aws iam get-role-policy \
            --role-name "$DEPLOY_ROLE_NAME" \
            --policy-name "$POLICY_NAMES" \
            --query 'PolicyDocument' \
            --output json > /tmp/deployed-policy-raw.json

          if [ $? -ne 0 ]; then
            echo "⚠️  WARNING: Failed to retrieve deployed policy"
            exit 0
          fi

          echo "✓ Retrieved deployed policy"
          echo ""

          echo "Normalising policies for comparison..."

          .github/scripts/normalise-policy.sh \
            "$POLICY_FILE" \
            "$AWS_ACCOUNT_ID" \
            "$AWS_REGION" \
            "$ENV" \
            > /tmp/repository-policy-normalised.json

          cat /tmp/deployed-policy-raw.json | jq --sort-keys '.' > /tmp/deployed-policy-normalised.json

          echo "✓ Policies normalised"
          echo ""

          echo "Comparing deployed policy with repository policy..."
          .github/scripts/compare-policies.sh \
            /tmp/deployed-policy-normalised.json \
            /tmp/repository-policy-normalised.json

          if grep -q "Policy differences detected" /tmp/comparison-output.txt 2>/dev/null; then
            echo "::error::Policy drift detected for $APP_NAME in $ENV environment"
            exit 1
          else
            echo "✓ No policy drift detected"
          fi

          exit 0
