AWSTemplateFormatVersion: '2010-09-09'
Description: >
  DevOps infrastructure for monorepo-fem exp environment.
  This template creates:
  - PolicyManager IAM role with OIDC authentication for GitHub Actions
  - Shared CloudWatch log group for application metrics
  - Scoped to resources with 'monorepo-fem-*' naming pattern

Parameters:
  GitHubOrganization:
    Type: String
    Default: sephnescence
    Description: GitHub organisation name

  GitHubRepository:
    Type: String
    Default: monorepo-fem
    Description: GitHub repository name

  Environment:
    Type: String
    Default: exp
    Description: Environment name (dev/exp/prod)
    AllowedValues:
      - dev
      - exp
      - prod

  DeploymentBranch:
    Type: String
    Default: deploy-exp
    Description: GitHub branch allowed to assume this role

  AWSAccountId:
    Type: String
    Default: '395380602678'
    Description: AWS Account ID for ARN construction

  AWSRegion:
    Type: String
    Default: ap-southeast-2
    Description: AWS Region for ARN construction

Resources:
  # Shared CloudWatch log group for application metrics
  # Apps can create log streams within this group but cannot modify the group itself
  MetricsLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/metrics/monorepo-fem-${Environment}'
      RetentionInDays: 7
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain

  # PolicyManager role for managing IAM policies during SAM deployments
  # This role is assumed by GitHub Actions via OIDC
  PolicyManagerRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'monorepo-fem-policy-manager-${Environment}'
      Description: !Sub 'Policy management role for monorepo-fem ${Environment} environment'

      # OIDC trust policy - allows GitHub Actions to assume this role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Federated: !Sub 'arn:aws:iam::${AWSAccountId}:oidc-provider/token.actions.githubusercontent.com'
            Action: 'sts:AssumeRoleWithWebIdentity'
            Condition:
              StringEquals:
                'token.actions.githubusercontent.com:aud': 'sts.amazonaws.com'
              StringLike:
                'token.actions.githubusercontent.com:sub': !Sub 'repo:${GitHubOrganization}/${GitHubRepository}:ref:refs/heads/${DeploymentBranch}'

      # Permissions for managing IAM policies and roles within monorepo-fem namespace
      Policies:
        - PolicyName: !Sub 'monorepo-fem-policy-management-${Environment}'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              # Allow creating and updating IAM policies for monorepo-fem resources
              - Effect: Allow
                Action:
                  - 'iam:CreatePolicy'
                  - 'iam:CreatePolicyVersion'
                  - 'iam:GetPolicy'
                  - 'iam:GetPolicyVersion'
                  - 'iam:ListPolicyVersions'
                Resource: !Sub 'arn:aws:iam::${AWSAccountId}:policy/monorepo-fem-*'

              # Allow attaching policies to monorepo-fem roles and resources
              - Effect: Allow
                Action:
                  - 'iam:AttachRolePolicy'
                  - 'iam:DetachRolePolicy'
                  - 'iam:GetRole'
                  - 'iam:GetRolePolicy'
                  - 'iam:PutRolePolicy'
                  - 'iam:DeleteRolePolicy'
                  - 'iam:ListAttachedRolePolicies'
                  - 'iam:ListRolePolicies'
                Resource: !Sub 'arn:aws:iam::${AWSAccountId}:role/monorepo-fem-*'

              # Allow passing monorepo-fem roles to services (required for SAM deployments)
              - Effect: Allow
                Action:
                  - 'iam:PassRole'
                Resource: !Sub 'arn:aws:iam::${AWSAccountId}:role/monorepo-fem-*'

              # Allow reading IAM resources for validation
              - Effect: Allow
                Action:
                  - 'iam:ListPolicies'
                  - 'iam:ListRoles'
                Resource: '*'

        # CloudWatch Logs permissions for managing application metrics
        - PolicyName: !Sub 'monorepo-fem-cloudwatch-management-${Environment}'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              # Allow apps to create log streams within the shared log group
              # Pattern allows app-specific log streams (e.g., heartbeat-publisher-*)
              - Effect: Allow
                Action:
                  - 'logs:CreateLogStream'
                  - 'logs:PutLogEvents'
                Resource: !Sub 'arn:aws:logs:${AWSRegion}:${AWSAccountId}:log-group:/aws/metrics/monorepo-fem-${Environment}:log-stream:*'

              # Allow reading log group configuration (but not modifying)
              - Effect: Allow
                Action:
                  - 'logs:DescribeLogGroups'
                  - 'logs:DescribeLogStreams'
                Resource: !Sub 'arn:aws:logs:${AWSRegion}:${AWSAccountId}:log-group:/aws/metrics/monorepo-fem-${Environment}:*'

        # SAM deployment permissions
        - PolicyName: !Sub 'monorepo-fem-sam-deployment-${Environment}'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              # CloudFormation permissions for SAM deployments
              - Effect: Allow
                Action:
                  - 'cloudformation:CreateStack'
                  - 'cloudformation:UpdateStack'
                  - 'cloudformation:DescribeStacks'
                  - 'cloudformation:DescribeStackEvents'
                  - 'cloudformation:DescribeStackResources'
                  - 'cloudformation:GetTemplate'
                  - 'cloudformation:ValidateTemplate'
                  - 'cloudformation:DescribeChangeSet'
                  - 'cloudformation:CreateChangeSet'
                  - 'cloudformation:ExecuteChangeSet'
                Resource: !Sub 'arn:aws:cloudformation:${AWSRegion}:${AWSAccountId}:stack/monorepo-fem-*'

              # S3 permissions for SAM deployment artifacts
              - Effect: Allow
                Action:
                  - 's3:CreateBucket'
                  - 's3:GetObject'
                  - 's3:PutObject'
                  - 's3:ListBucket'
                  - 's3:GetBucketLocation'
                  - 's3:PutBucketVersioning'
                  - 's3:GetBucketVersioning'
                Resource:
                  - !Sub 'arn:aws:s3:::monorepo-fem-*'
                  - !Sub 'arn:aws:s3:::monorepo-fem-*/*'

              # Lambda permissions for SAM deployments
              - Effect: Allow
                Action:
                  - 'lambda:CreateFunction'
                  - 'lambda:UpdateFunctionCode'
                  - 'lambda:UpdateFunctionConfiguration'
                  - 'lambda:GetFunction'
                  - 'lambda:GetFunctionConfiguration'
                  - 'lambda:ListFunctions'
                  - 'lambda:PublishVersion'
                  - 'lambda:CreateAlias'
                  - 'lambda:UpdateAlias'
                  - 'lambda:GetAlias'
                  - 'lambda:AddPermission'
                  - 'lambda:RemovePermission'
                  - 'lambda:GetPolicy'
                Resource: !Sub 'arn:aws:lambda:${AWSRegion}:${AWSAccountId}:function:monorepo-fem-*'

              # EventBridge permissions for Lambda triggers
              - Effect: Allow
                Action:
                  - 'events:PutRule'
                  - 'events:DescribeRule'
                  - 'events:PutTargets'
                  - 'events:RemoveTargets'
                  - 'events:EnableRule'
                  - 'events:DisableRule'
                Resource: !Sub 'arn:aws:events:${AWSRegion}:${AWSAccountId}:rule/monorepo-fem-*'

              # CloudWatch Logs permissions for Lambda log groups
              - Effect: Allow
                Action:
                  - 'logs:CreateLogGroup'
                  - 'logs:DescribeLogGroups'
                  - 'logs:PutRetentionPolicy'
                Resource: !Sub 'arn:aws:logs:${AWSRegion}:${AWSAccountId}:log-group:/aws/lambda/monorepo-fem-*'

Outputs:
  PolicyManagerRoleArn:
    Description: ARN of the PolicyManager IAM role
    Value: !GetAtt PolicyManagerRole.Arn
    Export:
      Name: !Sub 'monorepo-fem-policy-manager-role-arn-${Environment}'

  PolicyManagerRoleName:
    Description: Name of the PolicyManager IAM role
    Value: !Ref PolicyManagerRole
    Export:
      Name: !Sub 'monorepo-fem-policy-manager-role-name-${Environment}'

  MetricsLogGroupName:
    Description: Name of the shared metrics CloudWatch log group
    Value: !Ref MetricsLogGroup
    Export:
      Name: !Sub 'monorepo-fem-metrics-log-group-name-${Environment}'

  MetricsLogGroupArn:
    Description: ARN of the shared metrics CloudWatch log group
    Value: !GetAtt MetricsLogGroup.Arn
    Export:
      Name: !Sub 'monorepo-fem-metrics-log-group-arn-${Environment}'
