AWSTemplateFormatVersion: '2010-09-09'
Description: >
  DevOps infrastructure for monorepo-fem exp environment.
  This template creates:
  - PolicyManager IAM role with OIDC authentication for GitHub Actions
  - Shared CloudWatch log group for application metrics
  - Scoped to resources with 'monorepo-fem-*' naming pattern

Parameters:
  GitHubOrganization:
    Type: String
    Default: sephnescence
    Description: GitHub organisation name

  GitHubRepository:
    Type: String
    Default: monorepo-fem
    Description: GitHub repository name

  Environment:
    Type: String
    Default: exp
    Description: Environment name (dev/exp/prod)
    AllowedValues:
      - dev
      - exp
      - prod

  DeploymentBranch:
    Type: String
    Default: deploy-exp
    Description: GitHub branch allowed to assume this role

  AWSAccountId:
    Type: String
    Default: '395380602678'
    Description: AWS Account ID for ARN construction

  AWSRegion:
    Type: String
    Default: ap-southeast-2
    Description: AWS Region for ARN construction

Resources:
  # OIDC Provider for GitHub Actions authentication
  # Allows GitHub Actions workflows to assume AWS IAM roles without long-lived credentials
  GitHubOIDCProvider:
    Type: AWS::IAM::OIDCProvider
    Properties:
      Url: https://token.actions.githubusercontent.com
      ClientIdList:
        - sts.amazonaws.com
      ThumbprintList:
        - 6938fd4d98bab03faadb97b34396831e3780aea1
        - 1c58a3a8518e8759bf075b76b750d4f2df264fcd
      Tags:
        - Key: Name
          Value: !Sub 'monorepo-fem-github-oidc-provider-${Environment}'
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: CloudFormation

  # Shared CloudWatch log group for application metrics
  # Apps can create log streams within this group but cannot modify the group itself
  MetricsLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/metrics/monorepo-fem-${Environment}'
      RetentionInDays: 7
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain

  # PolicyManager role for managing IAM policies during SAM deployments
  # This role is assumed by GitHub Actions via OIDC
  PolicyManagerRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'monorepo-fem-policy-manager-${Environment}'
      Description: !Sub 'Policy management role for monorepo-fem ${Environment} environment'

      # OIDC trust policy - allows GitHub Actions to assume this role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Federated: !GetAtt GitHubOIDCProvider.Arn
            Action: 'sts:AssumeRoleWithWebIdentity'
            Condition:
              StringEquals:
                'token.actions.githubusercontent.com:aud': 'sts.amazonaws.com'
              StringLike:
                'token.actions.githubusercontent.com:sub': !Sub 'repo:${GitHubOrganization}/${GitHubRepository}:ref:refs/heads/${DeploymentBranch}'

      # Permissions for managing IAM policies and roles within monorepo-fem namespace
      Policies:
        - PolicyName: !Sub 'monorepo-fem-policy-management-${Environment}'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              # Allow creating and updating IAM policies for monorepo-fem resources
              - Effect: Allow
                Action:
                  - 'iam:CreatePolicy'
                  - 'iam:CreatePolicyVersion'
                  - 'iam:GetPolicy'
                  - 'iam:GetPolicyVersion'
                  - 'iam:ListPolicyVersions'
                Resource: !Sub 'arn:aws:iam::${AWSAccountId}:policy/monorepo-fem-*'

              # Allow attaching policies to monorepo-fem roles and resources
              - Effect: Allow
                Action:
                  - 'iam:AttachRolePolicy'
                  - 'iam:DetachRolePolicy'
                  - 'iam:GetRole'
                  - 'iam:GetRolePolicy'
                  - 'iam:PutRolePolicy'
                  - 'iam:DeleteRolePolicy'
                  - 'iam:ListAttachedRolePolicies'
                  - 'iam:ListRolePolicies'
                Resource: !Sub 'arn:aws:iam::${AWSAccountId}:role/monorepo-fem-*'

              # Allow passing monorepo-fem roles to services (required for SAM deployments)
              - Effect: Allow
                Action:
                  - 'iam:PassRole'
                Resource: !Sub 'arn:aws:iam::${AWSAccountId}:role/monorepo-fem-*'

              # Allow reading IAM resources for validation
              - Effect: Allow
                Action:
                  - 'iam:ListPolicies'
                  - 'iam:ListRoles'
                Resource: '*'

        # CloudWatch Logs permissions for managing application metrics
        - PolicyName: !Sub 'monorepo-fem-cloudwatch-management-${Environment}'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              # Allow apps to create log streams within the shared log group
              # Pattern allows app-specific log streams (e.g., heartbeat-publisher-*)
              - Effect: Allow
                Action:
                  - 'logs:CreateLogStream'
                  - 'logs:PutLogEvents'
                Resource: !Sub 'arn:aws:logs:${AWSRegion}:${AWSAccountId}:log-group:/aws/metrics/monorepo-fem-${Environment}:log-stream:*'

              # Allow reading log group configuration (but not modifying)
              - Effect: Allow
                Action:
                  - 'logs:DescribeLogGroups'
                  - 'logs:DescribeLogStreams'
                Resource: !Sub 'arn:aws:logs:${AWSRegion}:${AWSAccountId}:log-group:/aws/metrics/monorepo-fem-${Environment}:*'

        # SAM deployment permissions
        - PolicyName: !Sub 'monorepo-fem-sam-deployment-${Environment}'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              # CloudFormation permissions for SAM deployments
              - Effect: Allow
                Action:
                  - 'cloudformation:CreateStack'
                  - 'cloudformation:UpdateStack'
                  - 'cloudformation:DescribeStacks'
                  - 'cloudformation:DescribeStackEvents'
                  - 'cloudformation:DescribeStackResources'
                  - 'cloudformation:GetTemplate'
                  - 'cloudformation:ValidateTemplate'
                  - 'cloudformation:DescribeChangeSet'
                  - 'cloudformation:CreateChangeSet'
                  - 'cloudformation:ExecuteChangeSet'
                Resource: !Sub 'arn:aws:cloudformation:${AWSRegion}:${AWSAccountId}:stack/monorepo-fem-*'

              # S3 permissions for SAM deployment artifacts
              - Effect: Allow
                Action:
                  - 's3:CreateBucket'
                  - 's3:GetObject'
                  - 's3:PutObject'
                  - 's3:ListBucket'
                  - 's3:GetBucketLocation'
                  - 's3:PutBucketVersioning'
                  - 's3:GetBucketVersioning'
                Resource:
                  - !Sub 'arn:aws:s3:::monorepo-fem-*'
                  - !Sub 'arn:aws:s3:::monorepo-fem-*/*'

              # Lambda permissions for SAM deployments
              - Effect: Allow
                Action:
                  - 'lambda:CreateFunction'
                  - 'lambda:UpdateFunctionCode'
                  - 'lambda:UpdateFunctionConfiguration'
                  - 'lambda:GetFunction'
                  - 'lambda:GetFunctionConfiguration'
                  - 'lambda:ListFunctions'
                  - 'lambda:PublishVersion'
                  - 'lambda:CreateAlias'
                  - 'lambda:UpdateAlias'
                  - 'lambda:GetAlias'
                  - 'lambda:AddPermission'
                  - 'lambda:RemovePermission'
                  - 'lambda:GetPolicy'
                Resource: !Sub 'arn:aws:lambda:${AWSRegion}:${AWSAccountId}:function:monorepo-fem-*'

              # EventBridge permissions for Lambda triggers
              - Effect: Allow
                Action:
                  - 'events:PutRule'
                  - 'events:DescribeRule'
                  - 'events:PutTargets'
                  - 'events:RemoveTargets'
                  - 'events:EnableRule'
                  - 'events:DisableRule'
                Resource: !Sub 'arn:aws:events:${AWSRegion}:${AWSAccountId}:rule/monorepo-fem-*'

              # CloudWatch Logs permissions for Lambda log groups
              - Effect: Allow
                Action:
                  - 'logs:CreateLogGroup'
                  - 'logs:DescribeLogGroups'
                  - 'logs:PutRetentionPolicy'
                Resource: !Sub 'arn:aws:logs:${AWSRegion}:${AWSAccountId}:log-group:/aws/lambda/monorepo-fem-*'

  # Deployment role for Heartbeat Publisher application
  # Scoped to only deploy and manage heartbeat-publisher resources
  HeartbeatPublisherDeployRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'GitHubActionsDeployRole-HeartbeatPublisher-${Environment}'
      Description: !Sub 'Deployment role for heartbeat-publisher ${Environment} environment'
      MaxSessionDuration: 3600

      # OIDC trust policy - allows GitHub Actions to assume this role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Federated: !GetAtt GitHubOIDCProvider.Arn
            Action: 'sts:AssumeRoleWithWebIdentity'
            Condition:
              StringEquals:
                'token.actions.githubusercontent.com:aud': 'sts.amazonaws.com'
              StringLike:
                'token.actions.githubusercontent.com:sub': !Sub 'repo:${GitHubOrganization}/${GitHubRepository}:ref:refs/heads/${DeploymentBranch}'

      # Inline deployment permissions scoped to heartbeat-publisher resources
      Policies:
        - PolicyName: !Sub 'heartbeat-publisher-deploy-policy-${Environment}'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: CloudFormationAccess
                Effect: Allow
                Action:
                  - 'cloudformation:CreateChangeSet'
                  - 'cloudformation:CreateStack'
                  - 'cloudformation:DescribeChangeSet'
                  - 'cloudformation:DescribeStackEvents'
                  - 'cloudformation:DescribeStackResources'
                  - 'cloudformation:DescribeStacks'
                  - 'cloudformation:DeleteChangeSet'
                  - 'cloudformation:DeleteStack'
                  - 'cloudformation:ExecuteChangeSet'
                  - 'cloudformation:GetTemplate'
                  - 'cloudformation:GetTemplateSummary'
                  - 'cloudformation:ListChangeSets'
                  - 'cloudformation:RollbackStack'
                  - 'cloudformation:UpdateStack'
                  - 'cloudformation:ValidateTemplate'
                Resource:
                  - !Sub 'arn:aws:cloudformation:${AWSRegion}:${AWSAccountId}:stack/aws-sam-cli-managed-default-*'
                  - !Sub 'arn:aws:cloudformation:${AWSRegion}:${AWSAccountId}:stack/aws-sam-cli-managed-default/*'
                  - !Sub 'arn:aws:cloudformation:${AWSRegion}:${AWSAccountId}:stack/monorepo-fem-heartbeat-publisher-${Environment}*/*'
                  - !Sub 'arn:aws:cloudformation:${AWSRegion}:aws:transform/Serverless-2016-10-31'

              - Sid: S3DeploymentBucketAccess
                Effect: Allow
                Action:
                  - 's3:CreateBucket'
                  - 's3:DeleteObject'
                  - 's3:GetBucketLocation'
                  - 's3:GetBucketPolicy'
                  - 's3:GetBucketVersioning'
                  - 's3:GetObject'
                  - 's3:ListBucket'
                  - 's3:PutBucketPolicy'
                  - 's3:PutBucketVersioning'
                  - 's3:PutObject'
                Resource:
                  - 'arn:aws:s3:::aws-sam-cli-managed-default-samclisourcebucket-*'
                  - 'arn:aws:s3:::aws-sam-cli-managed-default-samclisourcebucket-*/*'

              - Sid: LambdaAccess
                Effect: Allow
                Action:
                  - 'lambda:AddPermission'
                  - 'lambda:CreateAlias'
                  - 'lambda:CreateFunction'
                  - 'lambda:DeleteAlias'
                  - 'lambda:DeleteFunction'
                  - 'lambda:GetFunction'
                  - 'lambda:GetAlias'
                  - 'lambda:GetFunctionConfiguration'
                  - 'lambda:GetPolicy'
                  - 'lambda:InvokeFunction'
                  - 'lambda:ListVersionsByFunction'
                  - 'lambda:PublishVersion'
                  - 'lambda:RemovePermission'
                  - 'lambda:TagResource'
                  - 'lambda:UpdateAlias'
                  - 'lambda:UntagResource'
                  - 'lambda:UpdateFunctionCode'
                  - 'lambda:UpdateFunctionConfiguration'
                Resource:
                  - !Sub 'arn:aws:lambda:${AWSRegion}:*:function:heartbeat-publisher-*'

              - Sid: IAMRoleAccess
                Effect: Allow
                Action:
                  - 'iam:AttachRolePolicy'
                  - 'iam:CreateRole'
                  - 'iam:DeleteRole'
                  - 'iam:DeleteRolePolicy'
                  - 'iam:DetachRolePolicy'
                  - 'iam:GetRole'
                  - 'iam:GetRolePolicy'
                  - 'iam:PassRole'
                  - 'iam:PutRolePolicy'
                  - 'iam:TagRole'
                  - 'iam:UntagRole'
                Resource:
                  - !Sub 'arn:aws:iam::*:role/heartbeat-publisher-*'

              - Sid: CloudWatchAccess
                Effect: Allow
                Action:
                  - 'cloudwatch:PutMetricAlarm'
                  - 'cloudwatch:DeleteAlarms'
                  - 'cloudwatch:DescribeAlarms'
                  - 'cloudwatch:PutDashboard'
                  - 'cloudwatch:DeleteDashboards'
                  - 'cloudwatch:GetDashboard'
                  - 'logs:CreateLogGroup'
                  - 'logs:DeleteLogGroup'
                  - 'logs:DeleteRetentionPolicy'
                  - 'logs:DescribeLogGroups'
                  - 'logs:DescribeMetricFilters'
                  - 'logs:PutMetricFilter'
                  - 'logs:DeleteMetricFilter'
                  - 'logs:PutRetentionPolicy'
                  - 'logs:TagLogGroup'
                  - 'logs:UntagLogGroup'
                Resource:
                  - !Sub 'arn:aws:logs:${AWSRegion}:${AWSAccountId}:log-group:/aws/lambda/heartbeat-publisher-*'
                  - !Sub 'arn:aws:logs:${AWSRegion}:${AWSAccountId}:log-group:/aws/lambda/heartbeat-publisher-*:*'
                  - !Sub 'arn:aws:logs:${AWSRegion}:${AWSAccountId}:log-group:/monorepo-fem/heartbeats-*'
                  - !Sub 'arn:aws:logs:${AWSRegion}:${AWSAccountId}:log-group:/monorepo-fem/heartbeats-*:*'
                  - !Sub 'arn:aws:logs:${AWSRegion}:${AWSAccountId}:log-group:/aws/metrics/monorepo-fem-*/heartbeat-publisher*'
                  - !Sub 'arn:aws:logs:${AWSRegion}:${AWSAccountId}:log-group:/aws/metrics/monorepo-fem-*/heartbeat-publisher*:*'

              - Sid: EventBridgeAccess
                Effect: Allow
                Action:
                  - 'events:DeleteRule'
                  - 'events:DescribeRule'
                  - 'events:DisableRule'
                  - 'events:EnableRule'
                  - 'events:ListTargetsByRule'
                  - 'events:PutRule'
                  - 'events:PutTargets'
                  - 'events:RemoveTargets'
                Resource:
                  - !Sub 'arn:aws:events:${AWSRegion}:*:rule/heartbeat-publisher-*'

      Tags:
        - Key: Name
          Value: !Sub 'GitHubActionsDeployRole-HeartbeatPublisher-${Environment}'
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: heartbeat-publisher
        - Key: ManagedBy
          Value: CloudFormation

  # Deployment role for Pulse Publisher application
  # Scoped to only deploy and manage pulse-publisher resources
  PulsePublisherDeployRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'GitHubActionsDeployRole-PulsePublisher-${Environment}'
      Description: !Sub 'Deployment role for pulse-publisher ${Environment} environment'
      MaxSessionDuration: 3600

      # OIDC trust policy - allows GitHub Actions to assume this role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Federated: !GetAtt GitHubOIDCProvider.Arn
            Action: 'sts:AssumeRoleWithWebIdentity'
            Condition:
              StringEquals:
                'token.actions.githubusercontent.com:aud': 'sts.amazonaws.com'
              StringLike:
                'token.actions.githubusercontent.com:sub': !Sub 'repo:${GitHubOrganization}/${GitHubRepository}:ref:refs/heads/${DeploymentBranch}'

      # Inline deployment permissions scoped to pulse-publisher resources
      Policies:
        - PolicyName: !Sub 'pulse-publisher-deploy-policy-${Environment}'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: CloudFormationAccess
                Effect: Allow
                Action:
                  - 'cloudformation:CreateChangeSet'
                  - 'cloudformation:CreateStack'
                  - 'cloudformation:DescribeChangeSet'
                  - 'cloudformation:DescribeStackEvents'
                  - 'cloudformation:DescribeStackResources'
                  - 'cloudformation:DescribeStacks'
                  - 'cloudformation:DeleteChangeSet'
                  - 'cloudformation:DeleteStack'
                  - 'cloudformation:ExecuteChangeSet'
                  - 'cloudformation:GetTemplate'
                  - 'cloudformation:GetTemplateSummary'
                  - 'cloudformation:ListChangeSets'
                  - 'cloudformation:RollbackStack'
                  - 'cloudformation:UpdateStack'
                  - 'cloudformation:ValidateTemplate'
                Resource:
                  - !Sub 'arn:aws:cloudformation:${AWSRegion}:${AWSAccountId}:stack/aws-sam-cli-managed-default-*'
                  - !Sub 'arn:aws:cloudformation:${AWSRegion}:${AWSAccountId}:stack/aws-sam-cli-managed-default/*'
                  - !Sub 'arn:aws:cloudformation:${AWSRegion}:${AWSAccountId}:stack/monorepo-fem-pulse-publisher-${Environment}*/*'
                  - !Sub 'arn:aws:cloudformation:${AWSRegion}:aws:transform/Serverless-2016-10-31'

              - Sid: S3DeploymentBucketAccess
                Effect: Allow
                Action:
                  - 's3:CreateBucket'
                  - 's3:DeleteObject'
                  - 's3:GetBucketLocation'
                  - 's3:GetBucketPolicy'
                  - 's3:GetBucketVersioning'
                  - 's3:GetObject'
                  - 's3:ListBucket'
                  - 's3:PutBucketPolicy'
                  - 's3:PutBucketVersioning'
                  - 's3:PutObject'
                Resource:
                  - 'arn:aws:s3:::aws-sam-cli-managed-default-samclisourcebucket-*'
                  - 'arn:aws:s3:::aws-sam-cli-managed-default-samclisourcebucket-*/*'

              - Sid: LambdaAccess
                Effect: Allow
                Action:
                  - 'lambda:AddPermission'
                  - 'lambda:CreateAlias'
                  - 'lambda:CreateFunction'
                  - 'lambda:DeleteAlias'
                  - 'lambda:DeleteFunction'
                  - 'lambda:GetFunction'
                  - 'lambda:GetAlias'
                  - 'lambda:GetFunctionConfiguration'
                  - 'lambda:GetPolicy'
                  - 'lambda:InvokeFunction'
                  - 'lambda:ListVersionsByFunction'
                  - 'lambda:PublishVersion'
                  - 'lambda:RemovePermission'
                  - 'lambda:TagResource'
                  - 'lambda:UpdateAlias'
                  - 'lambda:UntagResource'
                  - 'lambda:UpdateFunctionCode'
                  - 'lambda:UpdateFunctionConfiguration'
                Resource:
                  - !Sub 'arn:aws:lambda:${AWSRegion}:*:function:pulse-publisher-*'

              - Sid: IAMRoleAccess
                Effect: Allow
                Action:
                  - 'iam:AttachRolePolicy'
                  - 'iam:CreateRole'
                  - 'iam:DeleteRole'
                  - 'iam:DeleteRolePolicy'
                  - 'iam:DetachRolePolicy'
                  - 'iam:GetRole'
                  - 'iam:GetRolePolicy'
                  - 'iam:PassRole'
                  - 'iam:PutRolePolicy'
                  - 'iam:TagRole'
                  - 'iam:UntagRole'
                Resource:
                  - !Sub 'arn:aws:iam::*:role/pulse-publisher-*'

              - Sid: CloudWatchAccess
                Effect: Allow
                Action:
                  - 'cloudwatch:PutMetricAlarm'
                  - 'cloudwatch:DeleteAlarms'
                  - 'cloudwatch:DescribeAlarms'
                  - 'cloudwatch:PutDashboard'
                  - 'cloudwatch:DeleteDashboards'
                  - 'cloudwatch:GetDashboard'
                  - 'logs:CreateLogGroup'
                  - 'logs:DeleteLogGroup'
                  - 'logs:DeleteRetentionPolicy'
                  - 'logs:DescribeLogGroups'
                  - 'logs:DescribeMetricFilters'
                  - 'logs:PutMetricFilter'
                  - 'logs:DeleteMetricFilter'
                  - 'logs:PutRetentionPolicy'
                  - 'logs:TagLogGroup'
                  - 'logs:UntagLogGroup'
                Resource:
                  - !Sub 'arn:aws:logs:${AWSRegion}:${AWSAccountId}:log-group:/aws/lambda/pulse-publisher-*'
                  - !Sub 'arn:aws:logs:${AWSRegion}:${AWSAccountId}:log-group:/aws/lambda/pulse-publisher-*:*'
                  - !Sub 'arn:aws:logs:${AWSRegion}:${AWSAccountId}:log-group:/monorepo-fem/pulse-*'
                  - !Sub 'arn:aws:logs:${AWSRegion}:${AWSAccountId}:log-group:/monorepo-fem/pulse-*:*'
                  - !Sub 'arn:aws:logs:${AWSRegion}:${AWSAccountId}:log-group:/aws/metrics/monorepo-fem-*/pulse-publisher*'
                  - !Sub 'arn:aws:logs:${AWSRegion}:${AWSAccountId}:log-group:/aws/metrics/monorepo-fem-*/pulse-publisher*:*'

              - Sid: EventBridgeAccess
                Effect: Allow
                Action:
                  - 'events:DeleteRule'
                  - 'events:DescribeRule'
                  - 'events:DisableRule'
                  - 'events:EnableRule'
                  - 'events:ListTargetsByRule'
                  - 'events:PutRule'
                  - 'events:PutTargets'
                  - 'events:RemoveTargets'
                Resource:
                  - !Sub 'arn:aws:events:${AWSRegion}:*:rule/pulse-publisher-*'

      Tags:
        - Key: Name
          Value: !Sub 'GitHubActionsDeployRole-PulsePublisher-${Environment}'
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: pulse-publisher
        - Key: ManagedBy
          Value: CloudFormation

  # Deployment role for Scry Scraper application
  # Scoped to only deploy and manage scryscraper resources
  ScryScraperDeployRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'GitHubActionsDeployRole-ScrysScraper-${Environment}'
      Description: !Sub 'Deployment role for scryscraper ${Environment} environment'
      MaxSessionDuration: 3600

      # OIDC trust policy - allows GitHub Actions to assume this role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Federated: !GetAtt GitHubOIDCProvider.Arn
            Action: 'sts:AssumeRoleWithWebIdentity'
            Condition:
              StringEquals:
                'token.actions.githubusercontent.com:aud': 'sts.amazonaws.com'
              StringLike:
                'token.actions.githubusercontent.com:sub': !Sub 'repo:${GitHubOrganization}/${GitHubRepository}:ref:refs/heads/${DeploymentBranch}'

      # Inline deployment permissions scoped to scryscraper resources
      Policies:
        - PolicyName: !Sub 'scryscraper-deploy-policy-${Environment}'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: CloudFormationAccess
                Effect: Allow
                Action:
                  - 'cloudformation:CreateChangeSet'
                  - 'cloudformation:CreateStack'
                  - 'cloudformation:DescribeChangeSet'
                  - 'cloudformation:DescribeStackEvents'
                  - 'cloudformation:DescribeStackResources'
                  - 'cloudformation:DescribeStacks'
                  - 'cloudformation:DeleteChangeSet'
                  - 'cloudformation:DeleteStack'
                  - 'cloudformation:ExecuteChangeSet'
                  - 'cloudformation:GetTemplate'
                  - 'cloudformation:GetTemplateSummary'
                  - 'cloudformation:ListChangeSets'
                  - 'cloudformation:RollbackStack'
                  - 'cloudformation:UpdateStack'
                  - 'cloudformation:ValidateTemplate'
                Resource:
                  - !Sub 'arn:aws:cloudformation:${AWSRegion}:${AWSAccountId}:stack/aws-sam-cli-managed-default-*'
                  - !Sub 'arn:aws:cloudformation:${AWSRegion}:${AWSAccountId}:stack/aws-sam-cli-managed-default/*'
                  - !Sub 'arn:aws:cloudformation:${AWSRegion}:${AWSAccountId}:stack/monorepo-fem-scryscraper-${Environment}*/*'
                  - !Sub 'arn:aws:cloudformation:${AWSRegion}:aws:transform/Serverless-2016-10-31'

              - Sid: S3DeploymentBucketAccess
                Effect: Allow
                Action:
                  - 's3:CreateBucket'
                  - 's3:DeleteObject'
                  - 's3:GetBucketLocation'
                  - 's3:GetBucketPolicy'
                  - 's3:GetBucketVersioning'
                  - 's3:GetObject'
                  - 's3:ListBucket'
                  - 's3:PutBucketPolicy'
                  - 's3:PutBucketVersioning'
                  - 's3:PutObject'
                Resource:
                  - 'arn:aws:s3:::aws-sam-cli-managed-default-samclisourcebucket-*'
                  - 'arn:aws:s3:::aws-sam-cli-managed-default-samclisourcebucket-*/*'

              - Sid: LambdaAccess
                Effect: Allow
                Action:
                  - 'lambda:AddPermission'
                  - 'lambda:CreateAlias'
                  - 'lambda:CreateFunction'
                  - 'lambda:DeleteAlias'
                  - 'lambda:DeleteFunction'
                  - 'lambda:GetFunction'
                  - 'lambda:GetAlias'
                  - 'lambda:GetFunctionConfiguration'
                  - 'lambda:GetPolicy'
                  - 'lambda:InvokeFunction'
                  - 'lambda:ListVersionsByFunction'
                  - 'lambda:PublishVersion'
                  - 'lambda:RemovePermission'
                  - 'lambda:TagResource'
                  - 'lambda:UpdateAlias'
                  - 'lambda:UntagResource'
                  - 'lambda:UpdateFunctionCode'
                  - 'lambda:UpdateFunctionConfiguration'
                Resource:
                  - !Sub 'arn:aws:lambda:${AWSRegion}:*:function:scryscraper-*'

              - Sid: IAMRoleAccess
                Effect: Allow
                Action:
                  - 'iam:AttachRolePolicy'
                  - 'iam:CreateRole'
                  - 'iam:DeleteRole'
                  - 'iam:DeleteRolePolicy'
                  - 'iam:DetachRolePolicy'
                  - 'iam:GetRole'
                  - 'iam:GetRolePolicy'
                  - 'iam:PassRole'
                  - 'iam:PutRolePolicy'
                  - 'iam:TagRole'
                  - 'iam:UntagRole'
                Resource:
                  - !Sub 'arn:aws:iam::*:role/scryscraper-*'

              - Sid: CloudWatchAccess
                Effect: Allow
                Action:
                  - 'cloudwatch:PutMetricAlarm'
                  - 'cloudwatch:DeleteAlarms'
                  - 'cloudwatch:DescribeAlarms'
                  - 'cloudwatch:PutDashboard'
                  - 'cloudwatch:DeleteDashboards'
                  - 'cloudwatch:GetDashboard'
                  - 'logs:CreateLogGroup'
                  - 'logs:DeleteLogGroup'
                  - 'logs:DeleteRetentionPolicy'
                  - 'logs:DescribeLogGroups'
                  - 'logs:DescribeMetricFilters'
                  - 'logs:PutMetricFilter'
                  - 'logs:DeleteMetricFilter'
                  - 'logs:PutRetentionPolicy'
                  - 'logs:TagLogGroup'
                  - 'logs:UntagLogGroup'
                Resource:
                  - !Sub 'arn:aws:logs:${AWSRegion}:${AWSAccountId}:log-group:/aws/lambda/scryscraper-*'
                  - !Sub 'arn:aws:logs:${AWSRegion}:${AWSAccountId}:log-group:/aws/lambda/scryscraper-*:*'
                  - !Sub 'arn:aws:logs:${AWSRegion}:${AWSAccountId}:log-group:/aws/metrics/monorepo-fem-*/scryscraper*'
                  - !Sub 'arn:aws:logs:${AWSRegion}:${AWSAccountId}:log-group:/aws/metrics/monorepo-fem-*/scryscraper*:*'

              - Sid: EventBridgeAccess
                Effect: Allow
                Action:
                  - 'events:DeleteRule'
                  - 'events:DescribeRule'
                  - 'events:DisableRule'
                  - 'events:EnableRule'
                  - 'events:ListTargetsByRule'
                  - 'events:PutRule'
                  - 'events:PutTargets'
                  - 'events:RemoveTargets'
                Resource:
                  - !Sub 'arn:aws:events:${AWSRegion}:*:rule/scryscraper-*'

              - Sid: ScryScraperS3Access
                Effect: Allow
                Action:
                  - 's3:CreateBucket'
                  - 's3:DeleteBucket'
                  - 's3:DeleteBucketPolicy'
                  - 's3:GetBucketLocation'
                  - 's3:GetBucketPolicy'
                  - 's3:GetBucketVersioning'
                  - 's3:GetLifecycleConfiguration'
                  - 's3:ListBucket'
                  - 's3:PutBucketPolicy'
                  - 's3:PutBucketPublicAccessBlock'
                  - 's3:PutBucketVersioning'
                  - 's3:PutLifecycleConfiguration'
                Resource:
                  - !Sub 'arn:aws:s3:::monorepo-fem-scryscraper-cache-*'

              - Sid: ScryScraperDynamoDBAccess
                Effect: Allow
                Action:
                  - 'dynamodb:CreateTable'
                  - 'dynamodb:DeleteTable'
                  - 'dynamodb:DescribeTable'
                  - 'dynamodb:DescribeTimeToLive'
                  - 'dynamodb:ListTagsOfResource'
                  - 'dynamodb:TagResource'
                  - 'dynamodb:UntagResource'
                  - 'dynamodb:UpdateTable'
                  - 'dynamodb:UpdateTimeToLive'
                Resource:
                  - !Sub 'arn:aws:dynamodb:${AWSRegion}:${AWSAccountId}:table/monorepo-fem-scryscraper-*'

      Tags:
        - Key: Name
          Value: !Sub 'GitHubActionsDeployRole-ScrysScraper-${Environment}'
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: scryscraper
        - Key: ManagedBy
          Value: CloudFormation
Outputs:
  PolicyManagerRoleArn:
    Description: ARN of the PolicyManager IAM role
    Value: !GetAtt PolicyManagerRole.Arn
    Export:
      Name: !Sub 'monorepo-fem-policy-manager-role-arn-${Environment}'

  PolicyManagerRoleName:
    Description: Name of the PolicyManager IAM role
    Value: !Ref PolicyManagerRole
    Export:
      Name: !Sub 'monorepo-fem-policy-manager-role-name-${Environment}'

  MetricsLogGroupName:
    Description: Name of the shared metrics CloudWatch log group
    Value: !Ref MetricsLogGroup
    Export:
      Name: !Sub 'monorepo-fem-metrics-log-group-name-${Environment}'

  MetricsLogGroupArn:
    Description: ARN of the shared metrics CloudWatch log group
    Value: !GetAtt MetricsLogGroup.Arn
    Export:
      Name: !Sub 'monorepo-fem-metrics-log-group-arn-${Environment}'

  GitHubOIDCProviderArn:
    Description: ARN of the GitHub OIDC provider
    Value: !GetAtt GitHubOIDCProvider.Arn
    Export:
      Name: !Sub 'monorepo-fem-github-oidc-provider-arn-${Environment}'

  HeartbeatPublisherDeployRoleArn:
    Description: ARN of the Heartbeat Publisher deployment role
    Value: !GetAtt HeartbeatPublisherDeployRole.Arn
    Export:
      Name: !Sub 'monorepo-fem-heartbeat-publisher-deploy-role-arn-${Environment}'

  PulsePublisherDeployRoleArn:
    Description: ARN of the Pulse Publisher deployment role
    Value: !GetAtt PulsePublisherDeployRole.Arn
    Export:
      Name: !Sub 'monorepo-fem-pulse-publisher-deploy-role-arn-${Environment}'

  ScryScraperDeployRoleArn:
    Description: ARN of the Scry Scraper deployment role
    Value: !GetAtt ScryScraperDeployRole.Arn
    Export:
      Name: !Sub 'monorepo-fem-scryscraper-deploy-role-arn-${Environment}'
